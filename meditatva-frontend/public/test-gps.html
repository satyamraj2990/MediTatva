<!DOCTYPE html>
<html>
<head>
    <title>GPS Test - MediTatva</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 800px; 
            margin: 50px auto; 
            padding: 20px;
            background: #f5f5f5;
        }
        .container { 
            background: white; 
            padding: 30px; 
            border-radius: 10px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        button { 
            background: #3B82F6; 
            color: white; 
            padding: 15px 30px; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover { background: #2563EB; }
        .output { 
            margin-top: 20px; 
            padding: 15px; 
            background: #f8f9fa; 
            border-radius: 5px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 14px;
        }
        .success { color: #10b981; }
        .error { color: #ef4444; }
        .info { color: #3b82f6; }
        h1 { color: #1f2937; }
        h2 { color: #4b5563; margin-top: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üåç GPS Location Test</h1>
        <p>This page tests if your browser can access GPS location.</p>
        
        <button onclick="testLocation()">üîç Test Location Access</button>
        <button onclick="testHighAccuracy()">üìç Test High Accuracy GPS</button>
        <button onclick="testPermission()">üîê Check Permission Status</button>
        <button onclick="clearOutput()">üóëÔ∏è Clear Output</button>
        
        <div id="output" class="output"></div>
    </div>

    <script>
        const output = document.getElementById('output');
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'success' ? 'success' : type === 'error' ? 'error' : 'info';
            output.innerHTML += `<div class="${color}">[${timestamp}] ${message}</div>`;
            console.log(message);
        }
        
        function clearOutput() {
            output.innerHTML = '';
        }
        
        async function testPermission() {
            clearOutput();
            log('üîê Checking location permission status...', 'info');
            
            try {
                const result = await navigator.permissions.query({ name: 'geolocation' });
                log(`Permission state: ${result.state}`, result.state === 'granted' ? 'success' : 'error');
                log(`Possible states: granted, denied, prompt`, 'info');
                
                result.addEventListener('change', () => {
                    log(`Permission changed to: ${result.state}`, 'info');
                });
            } catch (error) {
                log(`Cannot check permissions: ${error.message}`, 'error');
            }
        }
        
        function testLocation() {
            clearOutput();
            log('üåç Testing basic location access...', 'info');
            
            if (!navigator.geolocation) {
                log('‚ùå Geolocation NOT supported by browser', 'error');
                return;
            }
            
            log('‚úÖ Geolocation API is supported', 'success');
            log('üì° Requesting current position...', 'info');
            
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    log('‚úÖ SUCCESS! Location obtained:', 'success');
                    log(`  Latitude: ${position.coords.latitude}`, 'success');
                    log(`  Longitude: ${position.coords.longitude}`, 'success');
                    log(`  Accuracy: ¬±${Math.round(position.coords.accuracy)} meters`, 'success');
                    log(`  Altitude: ${position.coords.altitude || 'N/A'}`, 'info');
                    log(`  Speed: ${position.coords.speed || 'N/A'}`, 'info');
                    log(`  Heading: ${position.coords.heading || 'N/A'}`, 'info');
                    log(`  Timestamp: ${new Date(position.timestamp).toLocaleString()}`, 'info');
                    
                    // Test geocoding
                    testGeocodingBoth(position.coords.latitude, position.coords.longitude);
                },
                (error) => {
                    log('‚ùå ERROR getting location:', 'error');
                    log(`  Error Code: ${error.code}`, 'error');
                    log(`  Error Message: ${error.message}`, 'error');
                    
                    switch(error.code) {
                        case 1:
                            log('  Reason: PERMISSION_DENIED - User denied location access', 'error');
                            log('  Fix: Click the lock icon in address bar and allow location', 'info');
                            break;
                        case 2:
                            log('  Reason: POSITION_UNAVAILABLE - GPS signal not available', 'error');
                            log('  Fix: Ensure GPS/location services are enabled on device', 'info');
                            break;
                        case 3:
                            log('  Reason: TIMEOUT - Request took too long', 'error');
                            log('  Fix: Try again or check GPS signal', 'info');
                            break;
                    }
                },
                {
                    enableHighAccuracy: false,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        }
        
        function testHighAccuracy() {
            clearOutput();
            log('üìç Testing HIGH ACCURACY GPS...', 'info');
            
            if (!navigator.geolocation) {
                log('‚ùå Geolocation NOT supported', 'error');
                return;
            }
            
            log('‚öôÔ∏è Settings: enableHighAccuracy=true, timeout=15s, maximumAge=0', 'info');
            log('üì° Requesting position... (may take longer for better accuracy)', 'info');
            
            const startTime = Date.now();
            
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const duration = ((Date.now() - startTime) / 1000).toFixed(2);
                    log(`‚úÖ SUCCESS in ${duration} seconds!`, 'success');
                    log(`  Latitude: ${position.coords.latitude}`, 'success');
                    log(`  Longitude: ${position.coords.longitude}`, 'success');
                    log(`  Accuracy: ¬±${Math.round(position.coords.accuracy)} meters`, 'success');
                    log(`  Timestamp: ${new Date(position.timestamp).toLocaleString()}`, 'info');
                    
                    if (position.coords.accuracy < 100) {
                        log('  ‚úÖ Excellent accuracy!', 'success');
                    } else if (position.coords.accuracy < 500) {
                        log('  ‚ö†Ô∏è Moderate accuracy', 'info');
                    } else {
                        log('  ‚ö†Ô∏è Low accuracy - try moving outdoors', 'error');
                    }
                    
                    testGeocodingBoth(position.coords.latitude, position.coords.longitude);
                },
                (error) => {
                    const duration = ((Date.now() - startTime) / 1000).toFixed(2);
                    log(`‚ùå ERROR after ${duration} seconds:`, 'error');
                    log(`  Code: ${error.code}`, 'error');
                    log(`  Message: ${error.message}`, 'error');
                    
                    if (error.code === 1) {
                        log('\nüîß HOW TO FIX PERMISSION DENIED:', 'info');
                        log('  1. Click the lock/info icon in browser address bar', 'info');
                        log('  2. Find "Location" permission', 'info');
                        log('  3. Change to "Allow"', 'info');
                        log('  4. Refresh this page and try again', 'info');
                    } else if (error.code === 3) {
                        log('\n‚è±Ô∏è TIMEOUT - GPS took too long', 'error');
                        log('  Try: Disable VPN, move outdoors, enable device location', 'info');
                    }
                },
                {
                    enableHighAccuracy: true,
                    timeout: 15000,
                    maximumAge: 0
                }
            );
        }
        
        async function testGeocodingBoth(lat, lon) {
            log('\nüó∫Ô∏è Testing Reverse Geocoding...', 'info');
            
            // Test Google Maps API (Patient key)
            log('\n1Ô∏è‚É£ Testing Google Maps API (Patient Key)...', 'info');
            try {
                const patientKey = 'AIzaSyBNNB_456wwnLo57BSO89POATwS1FjsMjw';
                const googleUrl = `https://maps.googleapis.com/maps/api/geocode/json?latlng=${lat},${lon}&key=${patientKey}`;
                const response = await fetch(googleUrl);
                const data = await response.json();
                
                if (data.status === 'OK') {
                    log('‚úÖ Google Maps API (Patient) - SUCCESS', 'success');
                    log(`  Address: ${data.results[0].formatted_address}`, 'success');
                    
                    const components = data.results[0].address_components;
                    const city = components.find(c => c.types.includes('locality'))?.long_name;
                    const state = components.find(c => c.types.includes('administrative_area_level_1'))?.short_name;
                    const postal = components.find(c => c.types.includes('postal_code'))?.long_name;
                    
                    log(`  City: ${city || 'N/A'}`, 'info');
                    log(`  State: ${state || 'N/A'}`, 'info');
                    log(`  PIN: ${postal || 'N/A'}`, 'info');
                } else {
                    log(`‚ùå Google Maps API failed: ${data.status}`, 'error');
                    log(`  Error: ${data.error_message || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Google Maps API error: ${error.message}`, 'error');
            }
            
            // Test Nominatim
            log('\n2Ô∏è‚É£ Testing Nominatim (OpenStreetMap)...', 'info');
            try {
                const nominatimUrl = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=18&addressdetails=1`;
                const response = await fetch(nominatimUrl, {
                    headers: { 'User-Agent': 'MediTatva-Test' }
                });
                const data = await response.json();
                
                if (data.address) {
                    log('‚úÖ Nominatim - SUCCESS', 'success');
                    log(`  Display: ${data.display_name}`, 'success');
                    log(`  City: ${data.address.city || data.address.town || data.address.village || 'N/A'}`, 'info');
                    log(`  State: ${data.address.state || 'N/A'}`, 'info');
                    log(`  PIN: ${data.address.postcode || 'N/A'}`, 'info');
                } else {
                    log('‚ùå Nominatim failed to return address', 'error');
                }
            } catch (error) {
                log(`‚ùå Nominatim error: ${error.message}`, 'error');
            }
        }
        
        // Auto-run permission check on load
        window.addEventListener('load', () => {
            log('üåç MediTatva GPS Location Test Tool', 'info');
            log('Click buttons above to test different scenarios\n', 'info');
            testPermission();
        });
    </script>
</body>
</html>
